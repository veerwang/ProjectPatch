From c621e44dd839fe0609be6c3d0f3efffe719cf466 Mon Sep 17 00:00:00 2001
From: kevin <kevin.wang2004@hotmail.com>
Date: Wed, 30 Apr 2014 13:28:06 +0800
Subject: [PATCH] =?UTF-8?q?=E4=BF=AE=E6=AD=A3Makefile=E7=9B=AE=E5=BD=95,?=
 =?UTF-8?q?=E5=B9=B6=E4=B8=94=E6=B7=BB=E5=8A=A0=E8=AF=BB=E5=8F=96=E5=8F=82?=
 =?UTF-8?q?=E6=95=B0=E8=AE=B0=E5=BD=95=E4=BD=8D=E7=BD=AE=E7=9A=84=E5=8A=9F?=
 =?UTF-8?q?=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/EVA11/base/Global.cpp            |  3 +++
 src/EVA11/base/Global.h              |  5 +++++
 src/EVA11/base/Graphic.cpp           |  3 ++-
 src/EVA11/base/Loadwin.cpp           |  3 ++-
 src/EVA11/base/Logic.cpp             |  2 +-
 src/EVA11/base/Makefile              |  2 +-
 src/EVA11/base/OtherView.cpp         | 24 ++++++++++++------------
 src/EVA11/base/Parawin.cpp           |  4 +++-
 src/EVA11/base/main.cpp              | 18 ++++++++++++++----
 src/EVA11/base/main.h                |  6 +++---
 src/EVA11/entry/Makefile             |  2 +-
 src/EVA11/libetio/Makefile           |  2 +-
 src/EVA11/libresource-entry/Makefile |  2 +-
 src/EVA11/libresource/Makefile       |  2 +-
 src/EVA11/schedule/Makefile          |  2 +-
 15 files changed, 51 insertions(+), 29 deletions(-)

diff --git a/src/EVA11/base/Global.cpp b/src/EVA11/base/Global.cpp
index 5548a58..6c20af7 100644
--- a/src/EVA11/base/Global.cpp
+++ b/src/EVA11/base/Global.cpp
@@ -363,6 +363,9 @@ void Global::Init_Global_Variables()
 	CompositeChan        = 0;
 	
 	bRFFilterEnable      = false;
+
+	Loadwin_Index        = 27;
+	Parawin_Index        = 1;
 }
 
 std::ofstream& operator<<(std::ofstream& oo,const Global& ob)
diff --git a/src/EVA11/base/Global.h b/src/EVA11/base/Global.h
index 943370c..1f69670 100644
--- a/src/EVA11/base/Global.h
+++ b/src/EVA11/base/Global.h
@@ -171,6 +171,11 @@ class Global
 		bool			bTickStop;
 		bool		        bTickPasuse;
 
+		/* ---------- which parameters slot need to save --------- */
+
+		int 			Loadwin_Index;
+		int 			Parawin_Index;
+
 		/* ---------- normal data --------- */
 		int		 	DebugChan;            /* When enter debug function, it deside which signal channel to display */
 
diff --git a/src/EVA11/base/Graphic.cpp b/src/EVA11/base/Graphic.cpp
index c93455f..5ff0c1e 100644
--- a/src/EVA11/base/Graphic.cpp
+++ b/src/EVA11/base/Graphic.cpp
@@ -91,7 +91,7 @@ bool Graphic::Initgraph(void)
 	int m = compiled.major;
 	int n = compiled.minor;
 	int p = compiled.patch;
-	std::cout<<"Version: "<<m<<"."<<n<<"."<<p<<std::endl;
+	std::cout<<"GUI Version: "<<m<<"."<<n<<"."<<p<<std::endl;
 
 	SDL_IMAGE_VERSION(&compiled);
 	m = compiled.major;
@@ -343,6 +343,7 @@ void Graphic::DrawFillRect(int x,int y,int width,int height)
 		m_Imple->gc->HLine_Fast(x,x+width-1,i,m_Imple->m_Color);
 	}
 }
+
 /* 
  * ===  FUNCTION  ======================================================================
  *         Name:  DrawFillRect
diff --git a/src/EVA11/base/Loadwin.cpp b/src/EVA11/base/Loadwin.cpp
index 4e7f713..d80b883 100644
--- a/src/EVA11/base/Loadwin.cpp
+++ b/src/EVA11/base/Loadwin.cpp
@@ -75,7 +75,7 @@ void Loadwin::Init_GUI(Graphic& g)
 	m_NorLable[26]->Set_Label_Color(Label::LA_BGFO_COLOR,g_BUBGFO_CO);
 
 	m_BottomFocus = 1;
-	m_NormalFocus = 27;
+	m_NormalFocus = m_gp->Loadwin_Index;
 	m_NorLable[m_NormalFocus-1]->Set_Focus(true);
 	m_BomButton[m_BottomFocus-1]->Set_Focus(true);
 
@@ -467,6 +467,7 @@ void Loadwin::DrawBottomFocus(Graphic& g,int index)
 			}
 			break;
 	}				/* -----  end switch  ----- */
+	m_gp->Loadwin_Index = m_NormalFocus;
 #ifdef X86
 	g.Update_Rect(0,0,640,480);
 #endif
diff --git a/src/EVA11/base/Logic.cpp b/src/EVA11/base/Logic.cpp
index 4e72ab7..918d8e7 100644
--- a/src/EVA11/base/Logic.cpp
+++ b/src/EVA11/base/Logic.cpp
@@ -299,7 +299,7 @@ int Logic::Get_Key_From_Keyboard()
 	}
 	else
 	{
-		if 	( key == 0x7fffffff )
+		if 	( key == 0xffffffff )
 			return 0;
 		else
 			return key;                    			/* Normal key return immediately */
diff --git a/src/EVA11/base/Makefile b/src/EVA11/base/Makefile
index 2524130..c3b2678 100644
--- a/src/EVA11/base/Makefile
+++ b/src/EVA11/base/Makefile
@@ -12,7 +12,7 @@
 #LOOPDIR:=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'DEPS' -prune -o -name '*' -type d -print)
 #SRCS+=$(wildcard $(foreach DIR,$(LOOPDIR),$(DIR))/*.cpp)
 
-EXEC     := main_smart2005a
+EXEC     := main_$(shell basename $(shell pwd))
 
 include MKlib.mk
 
diff --git a/src/EVA11/base/OtherView.cpp b/src/EVA11/base/OtherView.cpp
index 86de83f..850151a 100644
--- a/src/EVA11/base/OtherView.cpp
+++ b/src/EVA11/base/OtherView.cpp
@@ -185,49 +185,49 @@ void OtherView::Switch_View()
 
 int OtherView::Key_NL1_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL1_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL1_Fun(g,sub);
 }
 int OtherView::Key_NR1_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR1_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR1_Fun(g,sub);
 }
 int OtherView::Key_NL2_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL2_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL2_Fun(g,sub);
 }
 int OtherView::Key_NR2_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR2_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR2_Fun(g,sub);
 }
 int OtherView::Key_NL3_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL3_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL3_Fun(g,sub);
 }
 int OtherView::Key_NR3_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR3_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR3_Fun(g,sub);
 }
 int OtherView::Key_NL4_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL4_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL4_Fun(g,sub);
 }
 int OtherView::Key_NR4_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR4_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR4_Fun(g,sub);
 }
 int OtherView::Key_NL5_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL5_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL5_Fun(g,sub);
 }
 int OtherView::Key_NR5_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR5_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR5_Fun(g,sub);
 }
 int OtherView::Key_NL6_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NL6_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NL6_Fun(g,sub);
 }
 int OtherView::Key_NR6_Fun(Graphic& g,int sub)
 {
-	m_PanelView->Key_NR6_Fun(g,sub);
+	if ( sub == 3 ) m_PanelView->Key_NR6_Fun(g,sub);
 }
diff --git a/src/EVA11/base/Parawin.cpp b/src/EVA11/base/Parawin.cpp
index f33f15d..ecf04c6 100644
--- a/src/EVA11/base/Parawin.cpp
+++ b/src/EVA11/base/Parawin.cpp
@@ -76,7 +76,7 @@ int Parawin::Loopwindow(Graphic& g)
 	Save_Screen_Into_Memory(g);
 	int result    = 0;
 	m_BottomFocus = 1;
-	m_NormalFocus = 1;
+	m_NormalFocus = m_gp->Parawin_Index;
 	Init_Normal_Title();
 	Init_Normal_Lines();
 	Init_GUI(g);
@@ -566,6 +566,8 @@ int Parawin::Key_Bom5_Fun(Graphic& g)
 
 					m_alg->Calculate_Gain_Ratio(m_gp->GainRatio);
 
+					m_gp->Parawin_Index = m_NormalFocus;
+
 					return CO_LOADEXIT;
 				}
 				else
diff --git a/src/EVA11/base/main.cpp b/src/EVA11/base/main.cpp
index b75bd88..cf39aec 100644
--- a/src/EVA11/base/main.cpp
+++ b/src/EVA11/base/main.cpp
@@ -29,6 +29,7 @@
 
 #include	"Basewin.h"
 #include	"Loadwin.h"
+#include	"Parawin.h"
 #include	"Mainwin.h"
 #include	"Global.h"
 #include 	"Initfacade.h"
@@ -150,7 +151,7 @@ Standard_ET_Fun()
 	db->Write_Operation_Log_Into_DB(m_pl->GetText(LOG_STARTUP));
 
 	Graphic *g = Graphic::Instance(); 
-
+	Global* gp = Global::Instance();
 MAINLOOP:
 	Loadwin *loadw = new Loadwin(*g,Loadwin::LT_LOAD);
 	int result = loadw->Loopwindow(*g);
@@ -162,7 +163,18 @@ MAINLOOP:
 		mwin->Loopwindow(*g);
 		delete mwin;
 		mwin = NULL;
-		goto MAINLOOP;
+
+		if ( result == Basewin::CO_OK )
+			goto MAINLOOP;
+		else if ( result == Basewin::CO_LOADEXIT )
+		{
+			Parawin *paraw;
+			paraw = new Parawin(Parawin::PT_LOAD,'a'+gp->Loadwin_Index-1);
+			result = paraw->Loopwindow(*g);
+			delete paraw;
+			paraw = NULL;
+			goto MAINLOOP;
+		}
 	}
 
 	db->Write_Operation_Log_Into_DB(m_pl->GetText(LOG_SHUTDOWN));
@@ -484,9 +496,7 @@ main ( int argc, char *argv[] )
 	act.sa_flags = SA_SIGINFO;     				/* * 设置SA_SIGINFO 表示传递附加信息到触发函数 **/  
 	act.sa_sigaction = Signal_Interrupt;  
 	if	( sigaction(SIGINT,&act,NULL) < 0 )
-	{
 		perror("install signal error\n");
-	}
 
 	ShellCommand *shc = new ShellCommand();
 	shc->SetVer(PROVERSION);
diff --git a/src/EVA11/base/main.h b/src/EVA11/base/main.h
index d3feb1f..38c4879 100644
--- a/src/EVA11/base/main.h
+++ b/src/EVA11/base/main.h
@@ -18,7 +18,7 @@
 #ifndef _MAINHEAD_
 #define _MAINHEAD_
 
-#define PROVERSION 	"1.02"
+#define PROVERSION 	"1.03"
 #define PAR_FILE_PATH	"/tmp/smart2005a.par"
 
 #ifdef ARM9
@@ -45,11 +45,11 @@
 #define _KEY_PC_                                      /* Used the PC keyboard */
 #else
 
-//#define _KEY_PC_                                      /* Used the PC keyboard */
+#define _KEY_PC_                                      /* Used the PC keyboard */
 //#define _KEY_308_A_                                   /* Smart2005A Array keyboard two board */
 //#define _KEY_308_1_                                   /* Smart-308 keyboard just only one board */
 //#define _KEY_308_2_                                   /* Smart-308 keyboard two board */
-#define _KEY_UT_                                        /* Used the PC keyboard */
+//#define _KEY_UT_                                        /* Used the PC keyboard */
 
 #endif
 
diff --git a/src/EVA11/entry/Makefile b/src/EVA11/entry/Makefile
index c1b4b7d..b8d1210 100644
--- a/src/EVA11/entry/Makefile
+++ b/src/EVA11/entry/Makefile
@@ -12,7 +12,7 @@
 #LOOPDIR:=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'DEPS' -prune -o -name '*' -type d -print)
 #SRCS+=$(wildcard $(foreach DIR,$(LOOPDIR),$(DIR))/*.cpp)
 
-EXEC     := main_entry
+EXEC     := main_$(shell basename $(shell pwd))
 
 include MKlib.mk
 
diff --git a/src/EVA11/libetio/Makefile b/src/EVA11/libetio/Makefile
index e91fcd3..5d3820b 100644
--- a/src/EVA11/libetio/Makefile
+++ b/src/EVA11/libetio/Makefile
@@ -8,7 +8,7 @@
 #            
 #
 ###########################################################
-LIBNAME  := libetio
+LIBNAME  := $(shell basename $(shell pwd))
 SONAME   := $(LIBNAME).so.0
 REALNAME := $(LIBNAME).so.0.0.0
 LINKNAME := $(LIBNAME).so
diff --git a/src/EVA11/libresource-entry/Makefile b/src/EVA11/libresource-entry/Makefile
index 53a86b8..d318dc0 100644
--- a/src/EVA11/libresource-entry/Makefile
+++ b/src/EVA11/libresource-entry/Makefile
@@ -8,7 +8,7 @@
 #            
 #
 ###########################################################
-LIBNAME  := libresource-entry
+LIBNAME  := $(shell basename $(shell pwd))
 STATICLIB:= $(LIBNAME).a
 
 TXTOBJS  :=OBJS
diff --git a/src/EVA11/libresource/Makefile b/src/EVA11/libresource/Makefile
index 4da3626..d318dc0 100644
--- a/src/EVA11/libresource/Makefile
+++ b/src/EVA11/libresource/Makefile
@@ -8,7 +8,7 @@
 #            
 #
 ###########################################################
-LIBNAME  := libresource
+LIBNAME  := $(shell basename $(shell pwd))
 STATICLIB:= $(LIBNAME).a
 
 TXTOBJS  :=OBJS
diff --git a/src/EVA11/schedule/Makefile b/src/EVA11/schedule/Makefile
index c07aed1..0ed40a7 100644
--- a/src/EVA11/schedule/Makefile
+++ b/src/EVA11/schedule/Makefile
@@ -12,7 +12,7 @@
 #LOOPDIR:=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'DEPS' -prune -o -name '*' -type d -print)
 #SRCS+=$(wildcard $(foreach DIR,$(LOOPDIR),$(DIR))/*.cpp)
 
-EXEC     := main_schedule
+EXEC     := main_$(shell basename $(shell pwd))
 
 SUBDIRS :=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'CASM' -o -path 'DEPS' -o -path 'Include' -prune -o -name '*' -type d -print)
 
-- 
1.9.2


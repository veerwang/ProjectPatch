From 8f7905b7ba3206c42c67ba1df5f928af43cf7e80 Mon Sep 17 00:00:00 2001
From: kevin <kevin.wang2004@hotmail.com>
Date: Fri, 28 Mar 2014 08:48:13 +0800
Subject: [PATCH 1/2] =?UTF-8?q?=E5=B0=86=E9=9D=99=E6=80=81=E7=B1=BB?=
 =?UTF-8?q?=E5=AF=B9=E8=B1=A1=E4=BF=AE=E6=94=B9=E4=B8=BA=E6=9E=9A=E4=B8=BE?=
 =?UTF-8?q?=E5=8F=98=E9=87=8F,=E5=B9=B6=E4=B8=94=E5=B0=86=E7=BC=96?=
 =?UTF-8?q?=E8=AF=91=E6=98=BE=E7=A4=BA=E4=BF=A1=E6=81=AF=E8=BF=9B=E8=A1=8C?=
 =?UTF-8?q?=E5=B1=8F=E8=94=BD,=E6=B7=BB=E5=8A=A0=E7=94=9F=E6=88=90?=
 =?UTF-8?q?=E6=B1=87=E7=BC=96=E6=96=87=E4=BB=B6=E5=8A=9F=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 Makefile                           |  5 +--
 makestatic.sh                      |  2 +-
 src/EVA11/base/Basewin.h           |  2 +-
 src/EVA11/base/CalculateCenter.cpp |  4 +--
 src/EVA11/base/Datawin.h           |  3 +-
 src/EVA11/base/Loadwin.h           |  2 +-
 src/EVA11/base/Mainwin.cpp         |  2 --
 src/EVA11/base/Mainwin.h           |  2 +-
 src/EVA11/base/Makefile            | 26 +++++++++++----
 src/EVA11/base/Parawin.h           |  3 +-
 src/EVA11/base/SubMakefile.mk      | 12 ++++---
 src/EVA11/base/Uart/cssl.c         | 67 ++++++++++++++++++++------------------
 src/EVA11/libetio/Makefile         | 12 ++++---
 src/EVA11/libresource/Makefile     | 12 ++++---
 14 files changed, 91 insertions(+), 63 deletions(-)

diff --git a/Makefile b/Makefile
index ac09cbf..ac1598a 100644
--- a/Makefile
+++ b/Makefile
@@ -15,6 +15,7 @@
 export PROJ     :=
 export DEBUG    :=
 export EXEC     := main_$(PROJ)
+export CASM     :=
 
 ###########################################################
 #     Compile Mode 
@@ -71,7 +72,7 @@ export LIBS 	    := pthread dl bz2 rt
 endif
 
 export CPP_COMPILE_FLAG \
-		    := -Werror -s -finline-functions
+		    := -Werror -finline-functions
 
 ifeq 	($(COMPILE),arm9)
 	CPP_COMPILE_FLAG += -std=c++11
@@ -80,7 +81,7 @@ else ifeq ($(COMPILE),x86)
 endif
 
 export C_COMPILE_FLAG \
-		    := -Wall -s -finline-functions
+		    := -Wall -finline-functions
 export FLAG 	    := -Wall 
 
 ###########################################################
diff --git a/makestatic.sh b/makestatic.sh
index 608a5cb..0742844 100755
--- a/makestatic.sh
+++ b/makestatic.sh
@@ -19,4 +19,4 @@
 
 set -o nounset                              # Treat unset variables as an error
 
-make PROJ=EVA11 CMOD=static
+make PROJ=EVA11 CMOD=static CASM=yes
diff --git a/src/EVA11/base/Basewin.h b/src/EVA11/base/Basewin.h
index f920f6f..d9dc13b 100644
--- a/src/EVA11/base/Basewin.h
+++ b/src/EVA11/base/Basewin.h
@@ -88,7 +88,7 @@ class Basewin
 
 		inline void Set_MAX_Get_Key_Interval(int value) { m_MAXGetkeyTimes = value; m_GetKeyTimes = m_MAXGetkeyTimes; }
 	protected:
-		static const int  		     MAXBOMCOUNT   = 5;
+		enum 				     { MAXBOMCOUNT   = 5 };
 		int               		     m_BottomFocus;
 
 		unsigned int			     m_MAXGetkeyTimes;
diff --git a/src/EVA11/base/CalculateCenter.cpp b/src/EVA11/base/CalculateCenter.cpp
index af46619..5a7cd59 100644
--- a/src/EVA11/base/CalculateCenter.cpp
+++ b/src/EVA11/base/CalculateCenter.cpp
@@ -236,7 +236,7 @@ void CalculateCenter::Calculate_AMP_PHA()
 	 *                       big
 	 *-----------------------------------------------------------------------------*/
 
-	if ( m_Imple->m_RL_Point == RLPOINT_R )           /* Left point to Right */
+	if ( m_Imple->m_RL_Point == RLPOINT_R )           	   /* Left point to Right */
 	{
 		if ( m_Imple->m_LMAXAMP.Y < m_Imple->m_RMAXAMP.Y ) /* Becare the compare must in hardware data arrange */
 		{
@@ -247,7 +247,7 @@ void CalculateCenter::Calculate_AMP_PHA()
 			m_Imple->m_PHA = 180 - m_Imple->m_PHA;
 		}
 	}
-	else                                     /* Right point to Left */
+	else                                     		   /* Right point to Left */
 	{
 		if ( m_Imple->m_LMAXAMP.Y < m_Imple->m_RMAXAMP.Y )
 		{
diff --git a/src/EVA11/base/Datawin.h b/src/EVA11/base/Datawin.h
index 886b466..0942d57 100644
--- a/src/EVA11/base/Datawin.h
+++ b/src/EVA11/base/Datawin.h
@@ -72,7 +72,8 @@ class Datawin : public Basewin
 		void Real_Do_Dele_Staff(Graphic& g);
 
 	protected:
-		static const int		     m_cMAXItem = 20;
+		enum 				    { m_cMAXItem = 20 };
+
 		DATAWINTYPE			     m_Type;
 
 		Label  				    *m_NorLable[m_cMAXItem];
diff --git a/src/EVA11/base/Loadwin.h b/src/EVA11/base/Loadwin.h
index 7b7a703..e242b83 100644
--- a/src/EVA11/base/Loadwin.h
+++ b/src/EVA11/base/Loadwin.h
@@ -64,7 +64,7 @@ class Loadwin : public Basewin
 		void Sub_Init_GUI(Graphic &);
 
 	protected:
-		static const int		     TITLECOUNT = 26;
+		enum 				     { TITLECOUNT = 26 };
 
 		int                                  m_NormalFocus;
 		std::string 			     m_Text[TITLECOUNT];
diff --git a/src/EVA11/base/Mainwin.cpp b/src/EVA11/base/Mainwin.cpp
index 3a72d01..64e0d2f 100644
--- a/src/EVA11/base/Mainwin.cpp
+++ b/src/EVA11/base/Mainwin.cpp
@@ -37,9 +37,7 @@
 #include 	"ParaView.h"
 #include	"DebugView.h"
 #include	"OtherView.h"
-//#include	"PanelView.h"
 #include 	"AlarmView.h"
-//#include 	"AnalyzeView.h"
 
 Mainwin::Mainwin ()
 {
diff --git a/src/EVA11/base/Mainwin.h b/src/EVA11/base/Mainwin.h
index b665139..bfd7cfc 100644
--- a/src/EVA11/base/Mainwin.h
+++ b/src/EVA11/base/Mainwin.h
@@ -148,7 +148,7 @@ class Mainwin : public Basewin
 		friend class 			     ParameterProcess;
 		friend class 			     DetectProcess;
 
-		static const int  		     MAXNORCOUNT = 6;
+		enum 				     { MAXNORCOUNT = 6 };
 
 		/*-----------------------------------------------------------------------------
 		 * Bottom buttons
diff --git a/src/EVA11/base/Makefile b/src/EVA11/base/Makefile
index 274cbdf..8a036ba 100644
--- a/src/EVA11/base/Makefile
+++ b/src/EVA11/base/Makefile
@@ -14,7 +14,7 @@
 
 include MKlib.mk
 
-SUBDIRS :=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'DEPS' -o -path 'Include' -prune -o -name '*' -type d -print)
+SUBDIRS :=$(shell find * -maxdepth 0 -path 'OBJS' -o -path 'CASM' -o -path 'DEPS' -o -path 'Include' -prune -o -name '*' -type d -print)
 
 ifeq ($(CMOD),dynamic)
 DYNAMICLIBS=$(THIRDLIB) $(LIBS)
@@ -26,9 +26,10 @@ endif
 
 TXTOBJS	:=OBJS
 TXTDEPS	:=DEPS
+TXTCASM :=CASM
 OBJS_DIR:=./$(TXTOBJS)/
 DEPS_DIR:=./$(TXTDEPS)/
-
+CASM_DIR:=./$(TXTCASM)/
 SRCS=
 SRCS+=$(wildcard *.cpp *.c)
 
@@ -91,20 +92,31 @@ depsdir:
 -include $(DEPS)
 
 $(EXEC):$(OBJS) $(SUBOBJS)
-	$(CPP) $(FLAG) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(DYNAMICLIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) $(SEARCH_LIBPATH) -Wl,-Bdynamic
+	@$(CPP) $(FLAG) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(DYNAMICLIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) $(SEARCH_LIBPATH) -Wl,-Bdynamic
+	@echo "G++ $(FLAG) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(DYNAMICLIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) -Wl,-Bdynamic"
 
 $(OBJS_DIR)%.c.o: %.c | objsdir
-	$(CC) $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@$(CC) $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@echo "GCC $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) -c $<"
 
 $(OBJS_DIR)%.cpp.o: %.cpp | objsdir
-	$(CPP) $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@$(CPP) $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+
+ifeq 	($(CASM),yes)
+	@$(CPP) $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -S $< -o $(CASM_DIR)/$<.s
+endif
+	@echo "G++ $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) -c $<"
 
 $(OBJS_DIR)%.s.o: %.s | objsdir
-	$(AS) $< -o $@
+	@$(AS) $< -o $@
+	@echo "AS $<"
 
 objsdir:
 	@mkdir -p $(OBJS_DIR)
+ifeq 	($(CASM),yes)
+	@mkdir -p $(CASM_DIR)
+endif
 
 .PHONY: clean
 clean: SUBSYSTEM
-	$(RM) -rf $(OBJS_DIR) $(DEPS_DIR) $(EXEC);
+	$(RM) -rf $(OBJS_DIR) $(DEPS_DIR) $(CASM_DIR) $(EXEC);
diff --git a/src/EVA11/base/Parawin.h b/src/EVA11/base/Parawin.h
index ce464df..b4d37ce 100644
--- a/src/EVA11/base/Parawin.h
+++ b/src/EVA11/base/Parawin.h
@@ -73,7 +73,8 @@ class Parawin : public Basewin
 		void Save_Item_Refresh_Item(Graphic& g);
 		void Show_Device_Help_Message(Graphic& g);
 	private:
-		static const int		     MAXNORCOUNT = 20;
+		enum 				    { MAXNORCOUNT = 20 };
+
 		int 				     m_NormalFocus;
 
 		Label  				    *m_Title;
diff --git a/src/EVA11/base/SubMakefile.mk b/src/EVA11/base/SubMakefile.mk
index 6ed4275..f56ebbf 100644
--- a/src/EVA11/base/SubMakefile.mk
+++ b/src/EVA11/base/SubMakefile.mk
@@ -69,16 +69,20 @@ depsdir:
 -include $(DEPS)
 
 build.o: $(OBJS)
-	$(LD) -r -EL $^ -o $@
+	@$(LD) -r -EL $^ -o $@
+	@echo "LD -r -EL $^ -o $@"
 
 $(OBJS_DIR)%.c.o: %.c | objsdir
-	$(CC) $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@$(CC) $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@echo "GCC $(C_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) -c $<"
 
 $(OBJS_DIR)%.cpp.o: %.cpp | objsdir
-	$(CPP) $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@$(CPP) $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) $(SEARCH_INCPATH) -c $< -o $@
+	@echo "G++ $(CPP_COMPILE_FLAG) $(DFLAG) $(COMPILE_FLAG) -c $<"
 
 $(OBJS_DIR)%.s.o: %.s | objsdir
-	$(AS) $< -o $@
+	@$(AS) $< -o $@
+	@echo "AS $<"
 
 objsdir:
 	@mkdir -p $(OBJS_DIR)
diff --git a/src/EVA11/base/Uart/cssl.c b/src/EVA11/base/Uart/cssl.c
index a287d0a..3d11e26 100644
--- a/src/EVA11/base/Uart/cssl.c
+++ b/src/EVA11/base/Uart/cssl.c
@@ -449,36 +449,37 @@ void cssl_settimeout(cssl_t *serial, int timeout)
 void cssl_putchar(cssl_t *serial,
 		     char c)
 {
-    if (!cssl_started) 
-    {
-	cssl_error=CSSL_ERROR_NOTSTARTED;
-	return;
-    }
-    
-    if (!serial) 
-    {
-	cssl_error=CSSL_ERROR_NULLPOINTER;
-	return;
-    }
+	if (!cssl_started) 
+	{
+		cssl_error=CSSL_ERROR_NOTSTARTED;
+		return;
+	}
 
-    int result = write(serial->fd,&c,1);
+	if (!serial) 
+	{
+		cssl_error=CSSL_ERROR_NULLPOINTER;
+		return;
+	}
+
+	write(serial->fd,&c,1);
 }
 
 /* sending a null-terminated string */
 void cssl_putstring(cssl_t *serial,
 		     char *str)
 {
-    if (!cssl_started) {
-	cssl_error=CSSL_ERROR_NOTSTARTED;
-	return;
-    }
-    
-    if (!serial) {
-	cssl_error=CSSL_ERROR_NULLPOINTER;
-	return;
-    }
+	if (!cssl_started) {
+		cssl_error=CSSL_ERROR_NOTSTARTED;
+		return;
+	}
 
-    int result = write(serial->fd,str,strlen(str));
+	if (!serial) {
+		cssl_error=CSSL_ERROR_NULLPOINTER;
+		return;
+	}
+
+	//    int result = write(serial->fd,str,strlen(str));
+	write(serial->fd,str,strlen(str));
 }
 
 /* sending a data of known size */
@@ -486,17 +487,19 @@ void cssl_putdata(cssl_t *serial,
 		  uint8_t *data,
 		  int datalen)
 {
-    if (!cssl_started) {
-	cssl_error=CSSL_ERROR_NOTSTARTED;
-	return;
-    }
-    
-    if (!serial) {
-	cssl_error=CSSL_ERROR_NULLPOINTER;
-	return;
-    }    
+	if (!cssl_started) {
+		cssl_error=CSSL_ERROR_NOTSTARTED;
+		return;
+	}
+
+	if (!serial) {
+		cssl_error=CSSL_ERROR_NULLPOINTER;
+		return;
+	}    
+
+	//int result = write(serial->fd,data,datalen);
 
-    int result = write(serial->fd,data,datalen);
+	write(serial->fd,data,datalen);
 }
 
 void cssl_drain(cssl_t *serial)
diff --git a/src/EVA11/libetio/Makefile b/src/EVA11/libetio/Makefile
index c3ef47c..e91fcd3 100644
--- a/src/EVA11/libetio/Makefile
+++ b/src/EVA11/libetio/Makefile
@@ -54,12 +54,16 @@ depsdir:
 -include $(DEPS)
 
 $(REALNAME): $(OBJS)
-	$(CPP) -fPIC -DPIC -shared -Wl,-soname -Wl,$(SONAME) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(LIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) -Wl,-Bdynamic
-	$(AR) -r $(STATICLIB) $^
-	$(RANLIB) $(STATICLIB)
+	@$(CPP) -fPIC -DPIC -shared -Wl,-soname -Wl,$(SONAME) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(LIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) -Wl,-Bdynamic
+	@echo "G++ -fPIC -DPIC -shared -Wl,-soname -Wl,$(SONAME) -o $@ $^ -Wl,-Bdynamic $(addprefix -l,$(LIBS)) -Wl,-Bstatic $(addprefix -l,$(STATICLIBS)) -Wl,-Bdynamic"
+	@$(AR) -r $(STATICLIB) $^
+	@echo "AR -r $(STATICLIB) $^"
+	@$(RANLIB) $(STATICLIB)
+	@echo "RANLIB $(STATICLIB)"
 
 $(OBJS_DIR)%.cpp.o: %.cpp | objsdir
-	$(CPP) $(COMPILE_FLAG) $(DFLAG) $(EXTDEF) -c $< -o $@
+	@$(CPP) $(COMPILE_FLAG) $(DFLAG) $(EXTDEF) -c $< -o $@
+	@echo "G++ $(COMPILE_FLAG) $(DFLAG) $(EXTDEF) -c $< -o $@"
 
 objsdir:
 	@mkdir -p $(OBJS_DIR)
diff --git a/src/EVA11/libresource/Makefile b/src/EVA11/libresource/Makefile
index 82ad87c..4da3626 100644
--- a/src/EVA11/libresource/Makefile
+++ b/src/EVA11/libresource/Makefile
@@ -41,8 +41,10 @@ depsjpegdir:
 -include $(DEPS)
 
 $(STATICLIB): $(OBJS)
-	$(AR) -r $(STATICLIB) $^
-	$(RANLIB) $(STATICLIB)
+	@$(AR) -r $(STATICLIB) $^
+	@echo "AR -r $(STATICLIB) $^"
+	@$(RANLIB) $(STATICLIB)
+	@echo "RANLIB $(STATICLIB)"
 
 $(OBJS_DIR)%.jpg.o: %.jpg | objsjpegdir
 	$(makejpegresource)
@@ -55,11 +57,13 @@ $(OBJS_DIR)%.gif.o: %.gif | objsjpegdir
 
 ifeq ($(COMPILE),arm9)
 define makejpegresource
-	$(OBJCOPY) -I binary -O elf32-littlearm -B arm $< $@
+	@$(OBJCOPY) -I binary -O elf32-littlearm -B arm $< $@
+	@echo "OBJCOPY -I binary -O elf32-littlearm -B arm $< $@"
 endef
 else
 define makejpegresource
-	$(OBJCOPY) -I binary -O elf32-i386 -B i386 $< $@
+	@$(OBJCOPY) -I binary -O elf32-i386 -B i386 $< $@
+	@echo "OBJCOPY -I binary -O elf32-i386 -B i386 $< $@"
 endef
 endif
 
-- 
1.8.5.1

